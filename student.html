<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªçc Sinh - FaceID Auto</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; background: url('https://static.vinwonders.com/2023/02/kinh-thanh-hue-4.jpg') no-repeat center center fixed; background-size: cover; font-family: 'Segoe UI', sans-serif; }
        .glass-card { background: rgba(0, 0, 0, 0.6); border-radius: 30px; padding: 30px; text-align: center; width: 320px; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(15px); color: white; }
        h1 { font-size: 55px; margin: 5px 0; color: #55efc4; }
        #video { border-radius: 20px; background: #000; width: 100%; height: 230px; object-fit: cover; border: 2px solid #55efc4; }
        .btn-red { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; background: #ff7675; color: white; }
        input { width: 90%; padding: 12px; border-radius: 10px; border: none; background: rgba(255,255,255,0.2); color: white; text-align: center; margin-bottom: 5px; }
        .status-box { padding: 10px; border-radius: 10px; background: rgba(85, 239, 196, 0.1); color: #55efc4; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="glass-card">
        <h2 id="student-name">ƒêANG T·∫¢I...</h2>
        <h1 id="student-score">--</h1>
        <p style="font-size: 10px; letter-spacing: 2px;">ƒêI·ªÇM R√àN LUY·ªÜN</p>
        <video id="video" autoplay muted playsinline></video>
        <div id="face-status" class="status-box">ƒêang kh·ªüi ƒë·ªông AI...</div>
        
        <div style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
            <input type="text" id="reason-input" placeholder="L√Ω do xin ngh·ªâ...">
            <button class="btn-red" onclick="guiDonXinNghi()">G·ª¨I ƒê∆†N XIN NGH·ªà</button>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBuwC_mqQ0uO-5NSHLIJ5wq11dB-2kIop8",
        authDomain: "quanly-428c3.firebaseapp.com",
        databaseURL: "https://quanly-428c3-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "quanly-428c3",
        storageBucket: "quanly-428c3.firebasestorage.app",
        messagingSenderId: "1061659403130",
        appId: "1:1061659403130:web:1a2a23280ae1de0d3ecc3"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const urlParams = new URLSearchParams(window.location.search);const currentID = urlParams.get('id');

    let hasAttended = false;

    function loadStudentData() {
        if (!currentID) return;
        database.ref('users/' + currentID).on('value', snap => {
            const data = snap.val();
            if (data) {
                document.getElementById('student-name').innerText = data.ten;
                document.getElementById('student-score').innerText = data.diem_ren_luyen || 0;
            }
        });
    }

    async function initFace() {
        const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights/';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        document.getElementById('video').srcObject = stream;
        document.getElementById('face-status').innerText = "üîç ƒêang t√¨m khu√¥n m·∫∑t...";
        startDetection();
    }

    function startDetection() {
        const video = document.getElementById('video');
        setInterval(async () => {
            if (hasAttended) return;
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
            if (detections.length > 0) {
                document.getElementById('face-status').innerText = "‚úÖ ƒê√É NH·∫¨N DI·ªÜN - ƒêANG L∆ØU...";
                diemDanhThanhCong();
            }
        }, 1500);
    }

    function diemDanhThanhCong() {
        if (hasAttended) return;
        hasAttended = true;
        const date = new Date().toISOString().split('T')[0];
        database.ref('diem_danh/' + date + '/' + currentID).set({
            thoi_gian: new Date().toLocaleTimeString(),
            trang_thai: "C√≥ m·∫∑t (T·ª± ƒë·ªông)"
        }).then(() => {
            document.getElementById('face-status').innerHTML = "üåü ƒêI·ªÇM DANH TH√ÄNH C√îNG!";
            document.getElementById('face-status').style.background = "#55efc4";
            document.getElementById('face-status').style.color = "#000";
        });
    }

    function guiDonXinNghi() {
        const lyDo = document.getElementById('reason-input').value;
        if (!lyDo) return alert("Vui l√≤ng nh·∫≠p l√Ω do!");
        database.ref('xin_nghi/' + currentID).set({
            ten: document.getElementById('student-name').innerText,
            ly_do: lyDo,
            thoi_gian: new Date().toLocaleString()
        }).then(() => alert("ƒê√£ g·ª≠i ƒë∆°n xin ngh·ªâ!"));
    }

    loadStudentData();
    initFace();
</script>
</body>
</html>
