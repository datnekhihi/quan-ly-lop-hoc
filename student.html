<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªçc Sinh - Smart Attendee</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * { box-sizing: border-box; } 
        body { 
            margin: 0; padding: 0; min-height: 100vh; 
            display: flex; justify-content: center; align-items: center; 
            background: url('https://static.vinwonders.com/2023/02/kinh-thanh-hue-4.jpg') no-repeat center center fixed; 
            background-size: cover; font-family: 'Segoe UI', sans-serif;
            position: relative;
        }
        
        /* N√∫t tho√°t c·ªë ƒë·ªãnh, kh√¥ng ƒë·∫©y giao di·ªán */
        .btn-exit { 
            position: absolute; top: 15px; left: 15px; color: white; text-decoration: none; 
            background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 10px; 
            font-size: 14px; z-index: 999; border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(5px);
        }

        /* Th·∫ª ch·ª©a ch√≠nh - C·ªë ƒë·ªãnh ·ªü gi·ªØa m√†n h√¨nh */
        .glass-card { 
            background: rgba(0, 0, 0, 0.7); border-radius: 25px; padding: 25px; 
            text-align: center; width: 90%; max-width: 350px; 
            border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(15px); color: white;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; gap: 10px;
        }

        h2 { margin: 0; font-size: 22px; }
        h1 { font-size: 60px; margin: 0; color: #55efc4; line-height: 1; }
        .label { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; opacity: 0.8; }
        
        #video { border-radius: 15px; width: 100%; height: auto; aspect-ratio: 4/3; object-fit: cover; border: 2px solid #55efc4; }
        
        .status-box { padding: 12px; border-radius: 12px; background: rgba(85, 239, 196, 0.1); color: #55efc4; font-size: 14px; font-weight: bold; border: 1px solid rgba(85,239,196,0.3); }
        
        input { width: 100%; padding: 12px; border-radius: 10px; border: none; background: rgba(255,255,255,0.15); color: white; text-align: center; outline: none; }
        .btn-red { width: 100%; padding: 14px; border-radius: 12px; border: none; background: #ff7675; color: white; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <a href="index.html" class="btn-exit">‚Üê Tho√°t</a>

    <div class="glass-card">
        <h2 id="student-name">ƒêANG T·∫¢I...</h2>
        <h1 id="student-score">--</h1>
        <div class="label">ƒêI·ªÇM R√àN LUY·ªÜN</div><video id="video" autoplay muted playsinline></video>
        <div id="face-status" class="status-box">ƒêang kh·ªüi ƒë·ªông AI...</div>
        
        <div style="margin-top: 10px;">
            <input type="text" id="reason-input" placeholder="L√Ω do xin ngh·ªâ...">
            <button class="btn-red" style="margin-top:8px" onclick="guiDonXinNghi()">G·ª¨I ƒê∆†N XIN NGH·ªà</button>
        </div>
    </div>

<script>
    // C·∫•u h√¨nh Database ch√≠nh x√°c theo ·∫£nh s·ªë 2 v√† 4 c·ªßa b·∫°n
    const firebaseConfig = {
        apiKey: "AIzaSyBuwC_mqQ0uO-5NSHLIJ5wq11dB-2kIop8",
        authDomain: "quanly-428c3.firebaseapp.com",
        databaseURL: "https://quanly-428c3-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "quanly-428c3",
        storageBucket: "quanly-428c3.firebasestorage.app",
        messagingSenderId: "1061659403130",
        appId: "1:1061659403130:web:1a2a23280ae1de0d3ecc3"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // L·∫•y ID h·ªçc sinh t·ª´ URL (v√≠ d·ª•: ?id=HS01)
    const urlParams = new URLSearchParams(window.location.search);
    const currentID = urlParams.get('id') || 'HS01';

    function loadData() {
        database.ref(currentID).on('value', snap => {
            const data = snap.val();
            if (data) {
                document.getElementById('student-name').innerText = data.ten;
                document.getElementById('student-score').innerText = data.diem_ren_luyen;
            }
        });
    }

    async function initAI() {
        const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights/';
        try {
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            document.getElementById('video').srcObject = stream;
            document.getElementById('face-status').innerText = "üîç ƒêang t√¨m khu√¥n m·∫∑t...";
            
            // Logic qu√©t m·∫∑t t·ª± ƒë·ªông
            setInterval(async () => {
                const detections = await faceapi.detectAllFaces('video', new faceapi.TinyFaceDetectorOptions());
                if (detections.length > 0) {
                    document.getElementById('face-status').innerHTML = "‚≠ê ƒêI·ªÇM DANH TH√ÄNH C√îNG!";
                    document.getElementById('face-status').style.background = "#55efc4";
                    document.getElementById('face-status').style.color = "#000";
                }
            }, 2000);
        } catch (e) {
            document.getElementById('face-status').innerText = "‚ùå L·ªói: " + e.message;
        }
    }

    function guiDonXinNghi() {
        const lyDo = document.getElementById('reason-input').value;
        if(lyDo) {database.ref(currentID).update({ 
                ly_do_nghi: lyDo,
                thoi_gian_nghi: new Date().toLocaleString()
            }).then(() => alert("ƒê√£ g·ª≠i ƒë∆°n xin ngh·ªâ!"));
        }
    }

    loadData();
    initAI();
</script>
</body>
</html>
